<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Curtis Traction Analytics | Advanced</title>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

<style>
:root{
--bg:#f8f9fa;--card:#fff;--text:#1a202c;--sub:#718096;--border:#e2e8f0;--accent:#3182ce;
}
[data-theme="dark"]{
--bg:#171923;--card:#2d3748;--text:#f7fafc;--sub:#a0aec0;--border:#4a5568;--accent:#63b3ed;
}
body{margin:0;font-family:Inter;background:var(--bg);color:var(--text);display:flex;height:100vh}
nav{width:240px;border-right:1px solid var(--border);padding:15px;background:var(--card)}
main{flex:1;overflow:auto;padding:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:15px;margin-bottom:15px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px}
.kpi-label{font-size:11px;color:var(--sub);font-weight:700}
.kpi-val{font-family:JetBrains Mono;font-size:20px;font-weight:700}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
th{background:rgba(0,0,0,0.05)}
</style>
</head>

<body data-theme="light">

<nav>
<b>CURTIS <span style="color:var(--accent)">ANALYTICS</span></b><br><br>
<button onclick="file.click()">ðŸ“„ Upload</button>
<button onclick="toggleTheme()">ðŸŒ—</button>
<input type="file" id="file" hidden onchange="loadFile(this)">
</nav>

<main id="dash" style="display:none">

<!-- ENERGY KPIs -->
<div class="card">
<div class="grid">
<div><div class="kpi-label">Total Energy</div><div class="kpi-val" id="kWh">0</div></div>
<div><div class="kpi-label">Travel Time</div><div class="kpi-val" id="travelTime">--</div></div>
<div><div class="kpi-label">Field Time</div><div class="kpi-val" id="fieldTime">--</div></div>
<div><div class="kpi-label">Idle Loss (Wh)</div><div class="kpi-val" id="idleWh">0</div></div>
<div><div class="kpi-label">Regen (Wh)</div><div class="kpi-val" id="regenWh">0</div></div>
</div>
</div>

<!-- CHART -->
<div class="card">
<div id="chartPower" style="height:350px"></div>
</div>

<!-- PEAK EVENTS TABLE -->
<div class="card">
<b>âš  Peak Events Log</b>
<table>
<thead>
<tr><th>Metric</th><th>Value</th><th>Timestamp</th></tr>
</thead>
<tbody id="events"></tbody>
</table>
</div>

</main>

<script>
let theme='light';
function toggleTheme(){
theme=theme==='light'?'dark':'light';
document.body.dataset.theme=theme;
if(window.cache)render(window.cache);
}

function loadFile(i){
if(!i.files[0])return;
const f=i.files[0];
if(f.name.endsWith('.csv')){
Papa.parse(f,{header:true,complete:r=>process(r.data)});
}else{
const r=new FileReader();
r.onload=e=>{
const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
process(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
};
r.readAsArrayBuffer(f);
}
}

function process(data){
let stats={wh:0,regen:0,idle:0,travelT:0,fieldT:0};
let peaks={
p:{v:-1,t:''},s:{v:-1,t:''},
mt:{v:-1,t:''},ct:{v:-1,t:''}
};
let t=[],p=[],s=[];
let prev=null;

data.forEach(r=>{
const ts=new Date(r.timestamp||r.time);
if(isNaN(ts))return;
const V=+r.voltage||0,A=+r.current||0,spd=+r.speed||0;
const P=V*A;
if(prev){
const dt=(ts-prev)/1000;
if(dt>0&&dt<120){
const wh=P*dt/3600;
if(wh>0){
stats.wh+=wh;
if(spd<0.5&&P>10)stats.idle+=wh;
}else stats.regen+=Math.abs(wh);
if(+r.travel_mode)stats.travelT+=dt;
if(+r.field_mode)stats.fieldT+=dt;
}
}
prev=ts;

if(P>peaks.p.v){peaks.p={v:P,t:ts}}
if(spd>peaks.s.v){peaks.s={v:spd,t:ts}}
if(+r.mtr_temp>peaks.mt.v){peaks.mt={v:+r.mtr_temp,t:ts}}
if(+r.ctrl_temp>peaks.ct.v){peaks.ct={v:+r.ctrl_temp,t:ts}}

t.push(ts);p.push(P);s.push(spd);
});

window.cache={t,p,s,stats,peaks};
render(window.cache);
}

function fmtT(sec){
const h=Math.floor(sec/3600);
const m=Math.floor(sec%3600/60);
const s=Math.floor(sec%60);
return `${h}h ${m}m ${s}s`;
}

function render(d){
document.getElementById('dash').style.display='block';
document.getElementById('kWh').innerText=(d.stats.wh/1000).toFixed(3);
document.getElementById('idleWh').innerText=d.stats.idle.toFixed(1);
document.getElementById('regenWh').innerText=d.stats.regen.toFixed(1);
document.getElementById('travelTime').innerText=fmtT(d.stats.travelT);
document.getElementById('fieldTime').innerText=fmtT(d.stats.fieldT);

document.getElementById('events').innerHTML=`
<tr><td>Peak Power</td><td>${d.peaks.p.v.toFixed(1)} W</td><td>${d.peaks.p.t}</td></tr>
<tr><td>Peak Speed</td><td>${d.peaks.s.v.toFixed(1)} km/h</td><td>${d.peaks.s.t}</td></tr>
<tr><td>Peak Motor Temp</td><td>${d.peaks.mt.v.toFixed(1)} Â°C</td><td>${d.peaks.mt.t}</td></tr>
<tr><td>Peak Ctrl Temp</td><td>${d.peaks.ct.v.toFixed(1)} Â°C</td><td>${d.peaks.ct.t}</td></tr>
`;

Plotly.newPlot('chartPower',[
{x:d.t,y:d.p,name:'Power',fill:'tozeroy'},
{x:d.t,y:d.s,name:'Speed',yaxis:'y2'}
],{
yaxis:{title:'W'},yaxis2:{overlaying:'y',side:'right'},
paper_bgcolor:'transparent',plot_bgcolor:'transparent'
},{responsive:true});
}
</script>
</body>
</html>
