<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nandi Curtis Analytics | v10</title>
    
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #f8f9fa; --bg-card: #ffffff; --bg-side: #ffffff;
            --text-primary: #1a202c; --text-secondary: #718096;
            --border: #e2e8f0; --accent: #2b6cb0;
            
            /* Status Colors */
            --c-travel: #3182ce; --c-field: #d69e2e;
            --c-idle: #e53e3e; --c-regen: #38a169;
        }

        [data-theme="dark"] {
            --bg-body: #1a202c; --bg-card: #2d3748; --bg-side: #2d3748;
            --text-primary: #f7fafc; --text-secondary: #a0aec0;
            --border: #4a5568; --accent: #63b3ed;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-primary); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--bg-side); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; z-index: 20; }
        .brand { font-size: 18px; font-weight: 800; margin-bottom: 25px; display: flex; align-items: center; gap: 8px; color: var(--text-primary); }
        .brand span { color: var(--accent); }
        
        .upload-box { border: 2px dashed var(--border); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; margin-bottom: 15px; }
        .upload-box:hover { border-color: var(--accent); background: rgba(49, 130, 206, 0.05); }
        .upload-label { font-size: 13px; font-weight: 600; color: var(--accent); }
        
        .theme-toggle { margin-top: auto; padding: 10px; background: var(--bg-body); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; color: var(--text-primary); font-weight: 600; }

        /* Main Dashboard */
        .main { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; }
        
        /* Section Headers */
        .section-head { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-secondary); margin-bottom: 10px; border-left: 3px solid var(--accent); padding-left: 10px; }

        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .kpi-card { background: var(--bg-card); padding: 18px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.04); position: relative; }
        .kpi-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 6px; }
        .kpi-value { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 700; color: var(--text-primary); }
        .kpi-unit { font-size: 12px; color: var(--text-secondary); margin-left: 4px; }
        .kpi-desc { font-size: 11px; color: var(--text-secondary); margin-top: 6px; opacity: 0.8; }

        /* Charts */
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; min-height: 350px; }
        .chart-card { background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; }
        .chart-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--text-primary); }
        .full-width { grid-column: span 2; height: 400px; }

        /* Table */
        .table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
        th { background: var(--bg-body); text-align: left; padding: 12px 15px; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        tr:last-child td { border-bottom: none; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Mobile */
        @media (max-width: 1000px) {
            body { flex-direction: column; height: auto; overflow: visible; }
            .sidebar { width: 100%; height: auto; flex-direction: row; align-items: center; justify-content: space-between; padding: 15px; border-right: none; border-bottom: 1px solid var(--border); position: sticky; top: 0; }
            .brand { margin-bottom: 0; }
            .chart-row { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .upload-box { margin-bottom: 0; padding: 8px 15px; display: flex; align-items: center; gap: 10px; }
            .upload-label { font-size: 12px; }
            .theme-toggle { margin-top: 0; }
        }
    </style>
</head>
<body data-theme="light">

    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:15px; font-weight:600;">Processing Precision Data...</div>
    </div>

    <aside class="sidebar">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
            CURTIS<span>PRO</span>
        </div>
        
        <label class="upload-box">
            <input type="file" id="fileInput" accept=".csv, .xlsx" hidden onchange="handleFile(this)">
            <span class="upload-label">ðŸ“‚ Upload Log File</span>
        </label>
        
        <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ— Switch Theme</button>
        
        <div id="file-meta" style="margin-top:20px; font-size:11px; color:var(--text-secondary);">
            v10.0 Precision Build<br>Ready for analysis.
        </div>
    </aside>

    <main class="main" id="dashboard" style="display:none;">

        <div class="section-head">Performance Summary</div>
        <div class="kpi-grid">
            <div class="kpi-card" style="border-left: 4px solid var(--text-primary);">
                <div class="kpi-title">Total Energy Consumed</div>
                <div><span class="kpi-value" id="val-total-wh">0.0</span><span class="kpi-unit">Wh</span></div>
                <div class="kpi-desc">System Consumption</div>
            </div>
            
            <div class="kpi-card" style="border-left: 4px solid var(--c-regen);">
                <div class="kpi-title">Regenerated Energy</div>
                <div><span class="kpi-value" id="val-regen-wh">0.0</span><span class="kpi-unit">Wh</span></div>
                <div class="kpi-desc">Energy Recovered</div>
            </div>

            <div class="kpi-card" style="border-left: 4px solid var(--c-idle);">
                <div class="kpi-title">Idle Energy Loss</div>
                <div><span class="kpi-value" id="val-idle-wh">0.0</span><span class="kpi-unit">Wh</span></div>
                <div class="kpi-desc">Vehicle Stationary but On</div>
            </div>

            <div class="kpi-card" style="border-left: 4px solid var(--accent);">
                <div class="kpi-title">Duration</div>
                <div><span class="kpi-value" id="val-duration">0h 0m</span></div>
                <div class="kpi-desc">Total Log Time</div>
            </div>
        </div>

        <div class="section-head" style="margin-top:10px;">Operational Breakdown</div>
        <div class="kpi-grid">
             <div class="kpi-card" style="border-left: 4px solid var(--c-field);">
                <div class="kpi-title">Field Mode</div>
                <div style="display:flex; justify-content:space-between; align-items:end;">
                    <div><span class="kpi-value" id="val-field-wh">0.0</span><span class="kpi-unit">Wh</span></div>
                    <div style="font-weight:600; color:var(--text-secondary);" id="val-field-time">0h 0m</div>
                </div>
            </div>

            <div class="kpi-card" style="border-left: 4px solid var(--c-travel);">
                <div class="kpi-title">Travel Mode</div>
                <div style="display:flex; justify-content:space-between; align-items:end;">
                    <div><span class="kpi-value" id="val-travel-wh">0.0</span><span class="kpi-unit">Wh</span></div>
                    <div style="font-weight:600; color:var(--text-secondary);" id="val-travel-time">0h 0m</div>
                </div>
            </div>
        </div>

        <div class="section-head">Visual Analytics</div>
        
        <div class="chart-row">
            <div class="chart-card">
                <div class="chart-title">Cumulative Energy (Field vs Travel)</div>
                <div id="chart-cumul" style="flex:1;"></div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Motor Analysis (RPM vs Current)</div>
                <div id="chart-motor" style="flex:1;"></div>
            </div>
        </div>

        <div class="chart-row">
            <div class="chart-card full-width">
                <div class="chart-title">Power & Speed Timeline</div>
                <div id="chart-power" style="flex:1;"></div>
            </div>
        </div>

        <div class="section-head">Peak Events Log</div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Peak Value</th>
                        <th>Timestamp</th>
                        <th>Mode Context</th>
                    </tr>
                </thead>
                <tbody id="peak-table-body">
                    </tbody>
            </table>
        </div>

    </main>

    <script>
        // --- THEME ---
        let theme = 'light';
        function toggleTheme() {
            theme = theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            if(window.pData) render(window.pData);
        }

        // --- FILE HANDLING ---
        function handleFile(input) {
            if(!input.files[0]) return;
            const file = input.files[0];
            document.getElementById('file-meta').innerText = `${file.name}\n${(file.size/1024/1024).toFixed(2)} MB`;
            document.getElementById('loader').style.display = 'flex';
            
            setTimeout(() => {
                if(file.name.endsWith('.csv')) {
                    Papa.parse(file, { header:true, skipEmptyLines:true, complete: r => process(r.data) });
                } else {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:""});
                        process(json);
                    };
                    reader.readAsArrayBuffer(file);
                }
            }, 100);
        }

        // --- DATA PROCESSING ---
        function process(data) {
            if(!data || data.length < 5) return alert("File empty or invalid.");

            // 1. Map Columns
            const keys = Object.keys(data[0]);
            const find = (arr) => keys.find(k => arr.some(x => k.toLowerCase().includes(x)));

            const C = {
                t: find(['timestamp', 'time']),
                v: find(['voltage']),
                a: find(['current']),
                s: find(['speed']),
                rpm: find(['rpm']),
                trav: find(['travel_mode']),
                fld: find(['field_mode']),
                mt: find(['mtr_temp']),
                ct: find(['ctrl_temp'])
            };

            // 2. Variables
            const res = { t:[], p:[], s:[], rpm:[], a:[], cumF:[], cumT:[] };
            
            let stats = {
                whTotal: 0, whRegen: 0, whIdle: 0, whField: 0, whTravel: 0,
                tTotal: 0, tField: 0, tTravel: 0
            };

            let peaks = {
                spd: {v:0, t:'-'}, pwr: {v:0, t:'-'}, amp: {v:0, t:'-'}, 
                mt: {v:-99, t:'-'}, ct: {v:-99, t:'-'}
            };

            let prevT = null;
            let runF = 0, runT = 0;
            
            // Render Step (Decimation only for Charts, NOT calcs)
            const step = Math.ceil(data.length / 5000);

            // 3. Main Loop
            for(let i=0; i<data.length; i++) {
                const row = data[i];
                let tStr = row[C.t];
                if(!tStr) continue;

                // Precision Timestamp (handle nano)
                if(tStr.length > 23 && tStr.includes('.')) tStr = tStr.substring(0, 23);
                const dt = new Date(tStr);
                if(isNaN(dt)) continue;

                // Values
                const V = parseFloat(row[C.v])||0;
                const A = parseFloat(row[C.a])||0;
                const S = parseFloat(row[C.s])||0;
                const P = V * A;
                const RPM = parseFloat(row[C.rpm])||0;
                const MT = parseFloat(row[C.mt])||0;
                const CT = parseFloat(row[C.ct])||0;
                
                // Mode Logic
                const isField = parseInt(row[C.fld]) === 1;
                const isTravel = parseInt(row[C.trav]) === 1;

                // --- INTEGRATION ---
                if(prevT) {
                    const sec = (dt - prevT) / 1000;
                    if(sec > 0 && sec < 300) { // Skip large gaps
                        stats.tTotal += sec;
                        
                        // Time Stats
                        if(isField) stats.tField += sec;
                        else if(isTravel) stats.tTravel += sec;

                        // Energy Stats (Joules to Wh)
                        const wh = (P * sec) / 3600;
                        
                        if(wh > 0) {
                            stats.whTotal += wh;
                            
                            // Mode Attribution
                            if(isField) { stats.whField += wh; runF += wh; }
                            else if(isTravel) { stats.whTravel += wh; runT += wh; }
                            else { 
                                // Default to travel if moving, else unassigned
                                if(S > 0.5) { stats.whTravel += wh; runT += wh; }
                            }

                            // Idle Logic (Your specific requirement: Stationary but On)
                            if(S < 0.1 && P > 0) stats.whIdle += wh;

                        } else {
                            stats.whRegen += Math.abs(wh);
                        }
                    }
                }
                prevT = dt;

                // --- PEAKS ---
                const tDisp = tStr.split(' ')[1] || tStr;
                if(S > peaks.spd.v) peaks.spd = {v:S, t:tDisp, m: isField?'Field':'Travel'};
                if(P > peaks.pwr.v) peaks.pwr = {v:P, t:tDisp, m: isField?'Field':'Travel'};
                if(A > peaks.amp.v) peaks.amp = {v:A, t:tDisp, m: isField?'Field':'Travel'};
                if(MT > peaks.mt.v) peaks.mt = {v:MT, t:tDisp, m: '-'};
                if(CT > peaks.ct.v) peaks.ct = {v:CT, t:tDisp, m: '-'};

                // --- CHART DATA (Decimated) ---
                if(i % step === 0) {
                    res.t.push(tStr);
                    res.p.push(P);
                    res.s.push(S);
                    res.a.push(A);
                    res.rpm.push(RPM);
                    res.cumF.push(runF);
                    res.cumT.push(runT);
                }
            }

            window.pData = { res, stats, peaks };
            render(window.pData);
        }

        // --- RENDERING ---
        function render({ res, stats, peaks }) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';

            // 1. Formatters
            const fN = (n, d=1) => n.toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d});
            const fT = (s) => {
                const h = Math.floor(s/3600);
                const m = Math.floor((s%3600)/60);
                return `${h}h ${m}m`;
            };

            // 2. Update KPIs
            document.getElementById('val-total-wh').innerText = fN(stats.whTotal);
            document.getElementById('val-regen-wh').innerText = fN(stats.whRegen);
            document.getElementById('val-idle-wh').innerText = fN(stats.whIdle);
            document.getElementById('val-duration').innerText = fT(stats.tTotal);

            document.getElementById('val-field-wh').innerText = fN(stats.whField);
            document.getElementById('val-field-time').innerText = fT(stats.tField);
            document.getElementById('val-travel-wh').innerText = fN(stats.whTravel);
            document.getElementById('val-travel-time').innerText = fT(stats.tTravel);

            // 3. Update Table
            const tbody = document.getElementById('peak-table-body');
            const row = (l, v, u, t, m) => `<tr>
                <td><b>${l}</b></td>
                <td style="color:var(--accent); font-weight:700;">${fN(v, 2)} ${u}</td>
                <td>${t}</td>
                <td>${m}</td>
            </tr>`;
            
            tbody.innerHTML = 
                row("Peak Speed", peaks.spd.v, "km/h", peaks.spd.t, peaks.spd.m) +
                row("Peak Power", peaks.pwr.v, "W", peaks.pwr.t, peaks.pwr.m) +
                row("Peak Current", peaks.amp.v, "A", peaks.amp.t, peaks.amp.m) +
                row("Max Motor Temp", peaks.mt.v, "Â°C", peaks.mt.t, peaks.mt.m) +
                row("Max Ctrl Temp", peaks.ct.v, "Â°C", peaks.ct.t, peaks.ct.m);

            // 4. Render Charts
            const isDark = theme === 'dark';
            const tc = isDark ? '#e2e8f0' : '#2d3748';
            const gc = isDark ? '#4a5568' : '#e2e8f0';

            const layout = {
                paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                font: { family: 'Inter', color: tc, size: 11 },
                xaxis: { gridcolor: gc, zeroline:false }, yaxis: { gridcolor: gc, zeroline:false },
                margin: { t:30, r:10, l:40, b:30 },
                showlegend: true, legend: { orientation:'h', y:1.1 },
                hovermode: 'x unified'
            };
            const cfg = { responsive: true, displayModeBar: false };

            Plotly.newPlot('chart-cumul', [
                { x: res.t, y: res.cumT, name: 'Travel Wh', type: 'scattergl', line: {color: '#3182ce'} },
                { x: res.t, y: res.cumF, name: 'Field Wh', type: 'scattergl', line: {color: '#d69e2e'} }
            ], { ...layout, yaxis: { title: 'Watt-hours' } }, cfg);

            Plotly.newPlot('chart-motor', [
                { x: res.t, y: res.rpm, name: 'RPM', type: 'scattergl', line: {color: '#805ad5'} },
                { x: res.t, y: res.a, name: 'Current (A)', yaxis: 'y2', type: 'scattergl', line: {color: '#e53e3e'} }
            ], { ...layout, yaxis2: { overlaying: 'y', side: 'right' } }, cfg);

            Plotly.newPlot('chart-power', [
                { x: res.t, y: res.p, name: 'Power (W)', type: 'scattergl', fill:'tozeroy', line: {color: '#dd6b20', width:1} },
                { x: res.t, y: res.s, name: 'Speed', yaxis: 'y2', type: 'scattergl', line: {color: '#3182ce', width:2} }
            ], { ...layout, yaxis2: { overlaying: 'y', side: 'right' } }, cfg);
        }
    </script>
</body>
</html>
