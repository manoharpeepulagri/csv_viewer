<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precision Traction Dashboard v4</title>
    
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL RESET & THEME --- */
        :root {
            --bg-body: #0b0c0e;
            --bg-panel: #181b1f;
            --border: #34373c;
            --text-main: #e6e6e6;
            --text-mute: #9fa6b2;
            --accent: #3274d9;
            --danger: #f2495c;
            --success: #73bf69;
            --warn: #ff9830;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll on body */
            width: 100vw;
        }

        /* --- HEADER --- */
        .navbar {
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            width: 100%;
        }
        .navbar h1 { font-size: 18px; margin: 0; font-weight: 600; }
        .upload-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }
        .upload-btn:hover { background: #2860b2; }

        /* --- DASHBOARD GRID --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr); /* 12 Column Layout */
            gap: 15px;
            padding: 15px;
            width: 100%;
            max-width: 100%;
        }

        /* --- PANELS --- */
        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Contains chart overflow */
        }
        
        .panel-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-mute);
            text-transform: uppercase;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        /* --- SIZING CLASSES --- */
        .full-width { grid-column: span 12; height: 450px; }
        .half-width { grid-column: span 6; height: 400px; }
        .kpi-box    { grid-column: span 2; height: 100px; }

        /* Mobile Responsive */
        @media (max-width: 1200px) {
            .kpi-box { grid-column: span 4; }
            .half-width { grid-column: span 12; }
        }

        /* --- KPI STYLES --- */
        .kpi-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 22px;
            font-weight: 700;
            margin-top: auto;
            color: var(--text-main);
        }
        .kpi-unit { font-size: 12px; color: var(--text-mute); }

        /* --- PRECISION TABLE --- */
        .table-wrap {
            width: 100%;
            height: 100%;
            overflow: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-main);
        }
        th {
            text-align: left;
            padding: 8px;
            background: #22252b;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--border);
        }
        td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        tr:hover td { background: #22252b; }

        /* --- LOADER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(11,12,14,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
            color: var(--accent);
        }

    </style>
</head>
<body>

<div id="loader">
    <h2>Processing Data...</h2>
    <p>Parsing timestamps & calculating precision metrics</p>
</div>

<div class="navbar">
    <h1>TRACTION LOG ANALYZER <span style="font-size:12px; color:#666; margin-left:10px;">v4.0 PRECISION</span></h1>
    <div>
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Upload CSV/Excel</button>
        <input type="file" id="fileInput" accept=".csv, .xlsx" hidden>
    </div>
</div>

<div class="grid-container" id="dashboard" style="display:none;">

    <div class="panel kpi-box">
        <div class="panel-header">Total Energy</div>
        <div class="kpi-value" id="kpi-wh">0.0000</div>
    </div>
    <div class="panel kpi-box">
        <div class="panel-header">Regen Energy</div>
        <div class="kpi-value" id="kpi-regen" style="color: var(--success)">0.0000</div>
    </div>
    <div class="panel kpi-box">
        <div class="panel-header">Idle Loss</div>
        <div class="kpi-value" id="kpi-idle" style="color: var(--danger)">0.0000</div>
    </div>
    <div class="panel kpi-box">
        <div class="panel-header">Peak Current</div>
        <div class="kpi-value" id="kpi-curr">0.0000</div>
    </div>
    <div class="panel kpi-box">
        <div class="panel-header">Peak Power</div>
        <div class="kpi-value" id="kpi-pwr">0.0000</div>
    </div>
    <div class="panel kpi-box">
        <div class="panel-header">Max Motor Temp</div>
        <div class="kpi-value" id="kpi-temp">0.0000</div>
    </div>

    <div class="panel full-width">
        <div class="panel-header">Power & Speed Analysis (Precision View)</div>
        <div id="chart-main" style="width:100%; height:100%;"></div>
    </div>

    <div class="panel half-width">
        <div class="panel-header">Electrical (Voltage vs Current)</div>
        <div id="chart-elec" style="width:100%; height:100%;"></div>
    </div>

    <div class="panel half-width">
        <div class="panel-header">Peak Events Log (High Precision)</div>
        <div class="table-wrap">
            <table id="peak-table">
                <thead>
                    <tr>
                        <th>Event Type</th>
                        <th>Value</th>
                        <th>Timestamp (HH:MM:ss.SSS)</th>
                        <th>Travel Mode</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="panel full-width" style="height: 200px;">
        <div class="panel-header">Travel Mode Timeline</div>
        <div id="chart-modes" style="width:100%; height:100%;"></div>
    </div>

</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const loader = document.getElementById('loader');
    const dashboard = document.getElementById('dashboard');

    fileInput.addEventListener('change', handleFile);

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        loader.style.display = 'flex';
        dashboard.style.display = 'none';

        setTimeout(() => {
            if (file.name.endsWith('.csv')) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (res) => processData(res.data)
                });
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:""});
                    processData(json);
                };
                reader.readAsArrayBuffer(file);
            }
        }, 100);
    }

    function processData(data) {
        if (!data || data.length < 2) return alert("File empty");

        // --- 1. COLUMN MAPPING ---
        const keys = Object.keys(data[0]);
        const find = (arr) => keys.find(k => arr.some(x => k.toLowerCase().includes(x)));

        const C = {
            time: find(['timestamp', 'time']),
            spd: find(['speed']),
            volt: find(['voltage', 'volts']),
            amp: find(['current\na', 'current']),
            pwr: find(['power']), // If exists, else calc
            mode: find(['travel_mode', 'travel model']),
            mTemp: find(['mtr_temp']),
            cTemp: find(['ctrl_temp'])
        };

        // --- 2. VARIABLES ---
        const traces = { time: [], spd: [], pwr: [], volt: [], amp: [], mode: [], mTemp: [] };
        
        let stats = {
            wh: 0, regen: 0, idle: 0,
            maxA: 0, maxW: 0, maxT: -99,
            maxATime: '', maxWTime: '',
            maxAMode: '', maxWMode: ''
        };

        let prevTime = null;

        // --- 3. LOOP ---
        // Optimization: Render every Nth point if too large, but keep Peak precision
        const step = data.length > 80000 ? 5 : 1; 

        data.forEach((row, i) => {
            // Raw Values
            const tStr = row[C.time];
            const S = parseFloat(row[C.spd]) || 0;
            const V = parseFloat(row[C.volt]) || 0;
            const A = parseFloat(row[C.amp]) || 0;
            const M = row[C.mode] || "0";
            const T = parseFloat(row[C.mTemp]) || 0;
            
            // Calc Power
            const P = V * A;

            // Date Parsing (Fix for Nanoseconds & White Background text)
            // We strip nanoseconds for Date object, but keep string for display if needed
            let jsDate;
            try {
                // Takes "2025-12-12 09:44:38.399..." -> "2025-12-12 09:44:38.399"
                const cleanTime = tStr.length > 23 ? tStr.substring(0, 23) : tStr; 
                jsDate = new Date(cleanTime);
            } catch(e) { return; }

            if (isNaN(jsDate)) return;

            // --- STATISTICS ---
            // Peaks
            if (A > stats.maxA) { stats.maxA = A; stats.maxATime = tStr; stats.maxAMode = M; }
            if (P > stats.maxW) { stats.maxW = P; stats.maxWTime = tStr; stats.maxWMode = M; }
            if (T > stats.maxT) { stats.maxT = T; }

            // Energy Integration
            if (prevTime) {
                const dt = (jsDate - prevTime) / 1000; // seconds
                if (dt > 0 && dt < 300) {
                    const joules = P * dt;
                    const wh = joules / 3600;
                    
                    if (wh > 0) {
                        stats.wh += wh;
                        // Idle Check: Speed < 1kmph but Power > 10W
                        if (S < 1 && P > 10) stats.idle += wh;
                    } else {
                        stats.regen += Math.abs(wh);
                    }
                }
            }
            prevTime = jsDate;

            // --- PLOTTING DATA ---
            if (i % step === 0) {
                traces.time.push(jsDate.toISOString());
                traces.spd.push(S);
                traces.pwr.push(P);
                traces.volt.push(V);
                traces.amp.push(A);
                traces.mode.push(M);
                traces.mTemp.push(T);
            }
        });

        // --- 4. RENDER ---
        renderKPIs(stats);
        renderCharts(traces);
        renderTable(stats);

        loader.style.display = 'none';
        dashboard.style.display = 'grid';
    }

    // --- HELPER FUNCTIONS ---

    function fmt(val, dec=6) {
        return val.toLocaleString('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec });
    }

    function renderKPIs(s) {
        document.getElementById('kpi-wh').innerHTML = fmt(s.wh, 4) + '<span class="kpi-unit"> Wh</span>';
        document.getElementById('kpi-regen').innerHTML = fmt(s.regen, 4) + '<span class="kpi-unit"> Wh</span>';
        document.getElementById('kpi-idle').innerHTML = fmt(s.idle, 4) + '<span class="kpi-unit"> Wh</span>';
        document.getElementById('kpi-curr').innerHTML = fmt(s.maxA, 4) + '<span class="kpi-unit"> A</span>';
        document.getElementById('kpi-pwr').innerHTML = fmt(s.maxW, 4) + '<span class="kpi-unit"> W</span>';
        document.getElementById('kpi-temp').innerHTML = fmt(s.maxT, 2) + '<span class="kpi-unit"> °C</span>';
    }

    function renderTable(s) {
        const tbody = document.querySelector('#peak-table tbody');
        
        const row = (label, val, unit, time, mode) => {
            // Extract HH:MM:ss.SSS from timestamp string for cleaner display
            let cleanTime = time.split(' ')[1] || time; 
            // If it has long nanoseconds, truncate to 3 decimals
            if(cleanTime.includes('.') && cleanTime.length > 12) {
                 cleanTime = cleanTime.substring(0, 12); 
            }

            return `<tr>
                <td style="color:var(--accent); font-weight:bold;">${label}</td>
                <td style="font-size:13px;">${fmt(val, 6)} ${unit}</td>
                <td>${cleanTime}</td>
                <td>Mode ${mode}</td>
            </tr>`;
        };

        tbody.innerHTML = 
            row("Max Current", s.maxA, "A", s.maxATime, s.maxAMode) +
            row("Max Power", s.maxW, "W", s.maxWTime, s.maxWMode) +
            row("Max Temp", s.maxT, "°C", s.maxATime, "-"); // Assuming max temp time aligns roughly
    }

    function renderCharts(t) {
        const baseLayout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            font: { color: '#e6e6e6', family: 'Inter' },
            xaxis: { gridcolor: '#333', zeroline: false },
            yaxis: { gridcolor: '#333', zeroline: false },
            margin: { t: 30, l: 50, r: 50, b: 40 },
            hovermode: 'x unified',
            showlegend: true,
            legend: { orientation: 'h', y: 1.1 }
        };

        const config = { responsive: true, displayModeBar: false };

        // 1. MAIN CHART
        Plotly.newPlot('chart-main', [
            { x: t.time, y: t.pwr, name: 'Power (W)', type: 'scattergl', fill:'tozeroy', line: {color: '#ff9830', width:1} },
            { x: t.time, y: t.spd, name: 'Speed (km/h)', yaxis: 'y2', type: 'scattergl', line: {color: '#3274d9', width:2} }
        ], {
            ...baseLayout,
            yaxis: { title: 'Power (W)' },
            yaxis2: { title: 'Speed (km/h)', overlaying: 'y', side: 'right' }
        }, config);

        // 2. ELECTRICAL
        Plotly.newPlot('chart-elec', [
            { x: t.time, y: t.volt, name: 'Voltage (V)', type: 'scattergl', line: {color: '#73bf69'} },
            { x: t.time, y: t.amp, name: 'Current (A)', yaxis: 'y2', type: 'scattergl', line: {color: '#f2495c'} }
        ], {
            ...baseLayout,
            yaxis: { title: 'Voltage (V)' },
            yaxis2: { title: 'Current (A)', overlaying: 'y', side: 'right' }
        }, config);

        // 3. MODES STRIP (Heatmap style)
        // Convert modes to numeric for heatmap color
        const zData = t.mode.map(m => parseInt(m)||0);
        Plotly.newPlot('chart-modes', [{
            x: t.time,
            y: t.mode, // Y is categorical
            mode: 'markers',
            type: 'scattergl',
            marker: { 
                color: zData, 
                colorscale: 'Viridis',
                size: 5,
                symbol: 'square'
            }
        }], {
            ...baseLayout,
            yaxis: { title: 'Travel Mode', type: 'category' }
        }, config);
    }
</script>

</body>
</html>
